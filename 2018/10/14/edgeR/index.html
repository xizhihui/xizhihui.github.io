<!DOCTYPE html>
<html>
<head>
	<title>XZH's Notes</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="author" content="xizhihui" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link rel="stylesheet" type="text/css" href="/statics/reset.css">
	<link rel="stylesheet" type="text/css" href="/statics/header_footer.css"></link>
	<link rel="stylesheet" type="text/css" href="/statics/default.css">
	<link rel="stylesheet" type="text/css" href="/statics/main.css">
</head>
<body>
	<header class="Header">
		<nav>
			<h3>XZH</h3>
			<ul>
				<li><a href="/index.html#Timeline">Timeline</a></li><li><a href="/index.html#Category">Category</a></li><li><a href="/index.html#Tags">Tags</a></li><li><a href="/index.html#About">About</a></li>
			</ul>
		</nav>
	</header>
	<div class="Motto">
		<h2>XZH's Notes</h2>
		<h4>The future comes for you ~ ~ ~</h4>
	</div>

	<main>
		<nav id="table"></nav>
		<content id="content" class="content">
			<h2 id="edger">edgeR</h2>
<p>下方的代码把edgeR的三种差异分析整合成一个函数, 调用时直接指定参数即可.</p>
<ul>
<li>classcial</li>
<li>glm: likelihood ratio test/ quasi-likelihood F-test</li>
<li>
<ul>
<li>quasi-likelihood(qlf): 推荐用于差异分析，因为他对错误率限制较好。</li>
</ul>
</li>
<li>
<ul>
<li>likelihood(lrt)：对与单细胞RNA-测序和没有重复的数据较好</li>
</ul>
</li>
</ul>
<h3 id="_1">这是调用代码</h3>
<div class="codehilite"><pre><span></span><span class="kp">suppressPackageStartupMessages</span><span class="p">(</span><span class="kn">library</span><span class="p">(</span>edgeR<span class="p">))</span>
<span class="kp">setwd</span><span class="p">(</span><span class="s">&#39;~/practice/180716_edgeR/&#39;</span><span class="p">)</span>

rawdata <span class="o">=</span> read.table<span class="p">(</span><span class="s">&#39;rawdata.txt&#39;</span><span class="p">)</span>
<span class="kp">head</span><span class="p">(</span>rawdata<span class="p">)</span>
rawdata <span class="o">=</span> rawdata<span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">),]</span>

groups <span class="o">=</span> <span class="kp">grepl</span><span class="p">(</span><span class="s">&#39;01A&#39;</span><span class="p">,</span> <span class="kp">colnames</span><span class="p">(</span>rawdata<span class="p">))</span>
groups <span class="o">=</span> <span class="kp">ifelse</span><span class="p">(</span>groups<span class="p">,</span> <span class="s">&#39;tumor&#39;</span><span class="p">,</span> <span class="s">&#39;normal&#39;</span><span class="p">)</span>
<span class="kp">table</span><span class="p">(</span>groups<span class="p">)</span>

edgeR_DGE<span class="p">(</span>exprSet <span class="o">=</span> rawdata<span class="p">,</span> group<span class="o">=</span>groups<span class="p">,</span> type<span class="o">=</span><span class="s">&#39;classical&#39;</span><span class="p">)</span>
</pre></div>


<h3 id="_2">这是定义代码</h3>
<div class="codehilite"><pre><span></span>edgeR_DGE <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>exprSet<span class="p">,</span> group<span class="p">,</span> type<span class="p">,</span> cpm<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="m">100</span><span class="p">,</span><span class="m">4</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1"># 生成DEGList</span>
    DGE <span class="o">=</span> DGEList<span class="p">(</span>counts<span class="o">=</span>exprSet<span class="p">,</span> group<span class="o">=</span>group<span class="p">)</span>
    DGE.old <span class="o">=</span> DGE
    <span class="c1"># 生成design</span>
    design <span class="o">=</span> model.matrix<span class="p">(</span><span class="o">~</span>group<span class="p">)</span>
    <span class="c1"># cpm过滤</span>
    keep <span class="o">=</span> <span class="kp">rowSums</span><span class="p">(</span>edgeR<span class="o">::</span>cpm<span class="p">(</span>DGE<span class="p">)</span> <span class="o">&gt;</span> cpm<span class="p">[</span><span class="m">1</span><span class="p">])</span> <span class="o">&gt;=</span> cpm<span class="p">[</span><span class="m">2</span><span class="p">]</span>
    DGE <span class="o">=</span> DGE<span class="p">[</span>keep<span class="p">,]</span>
    <span class="c1"># 进行校正</span>
    DGE <span class="o">=</span> calcNormFactors<span class="p">(</span>DGE<span class="p">)</span>
    <span class="c1"># 检测离群值和关系</span>
    png<span class="p">(</span><span class="s">&#39;plotMDS.png&#39;</span><span class="p">)</span>
    plotMDS<span class="p">(</span>DGE<span class="p">,</span> method<span class="o">=</span><span class="s">&#39;bcv&#39;</span><span class="p">,</span> col<span class="o">=</span><span class="kp">as.numeric</span><span class="p">(</span>DGE<span class="o">$</span>samples<span class="o">$</span>group<span class="p">))</span>
    legendCol <span class="o">=</span> <span class="kp">unique</span><span class="p">(</span><span class="kp">as.numeric</span><span class="p">(</span>DGE<span class="o">$</span>samples<span class="o">$</span>group<span class="p">))</span>
    legendGroup <span class="o">=</span> <span class="kp">unique</span><span class="p">(</span><span class="kp">as.character</span><span class="p">(</span>DGE<span class="o">$</span>samples<span class="o">$</span>group<span class="p">))</span>
    legend<span class="p">(</span><span class="s">&quot;bottomright&quot;</span><span class="p">,</span> legendGroup<span class="p">,</span> col<span class="o">=</span>legendCol<span class="p">,</span> pch<span class="o">=</span><span class="m">20</span><span class="p">)</span>
    dev.off<span class="p">()</span>
    <span class="kr">if</span> <span class="p">(</span>type <span class="o">==</span> <span class="s">&#39;classical&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1"># 计算离散度dispersion</span>
        d <span class="o">=</span> estimateCommonDisp<span class="p">(</span>DGE<span class="p">)</span>
        d <span class="o">=</span> estimateTagwiseDisp<span class="p">(</span>d<span class="p">)</span>
        test <span class="o">=</span> exactTest<span class="p">(</span>d<span class="p">)</span>
    <span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>
        <span class="c1"># 计算离散度dispersion</span>
        d <span class="o">=</span> estimateGLMCommonDisp<span class="p">(</span>DGE<span class="p">)</span>
        d <span class="o">=</span> estimateGLMTrendedDisp<span class="p">(</span>d<span class="p">)</span>
        d <span class="o">=</span> estimateGLMTagwiseDisp<span class="p">(</span>d<span class="p">)</span>
        <span class="kr">if</span> <span class="p">(</span>type <span class="o">==</span> <span class="s">&#39;qlf&#39;</span><span class="p">)</span> <span class="p">{</span>
            fit <span class="o">=</span> glmQLFit<span class="p">(</span>d<span class="p">,</span> design<span class="p">)</span>
            test <span class="o">=</span> glmQLFTest<span class="p">(</span>fit<span class="p">,</span> coef<span class="o">=</span><span class="m">2</span><span class="p">)</span>
        <span class="p">}</span> <span class="kr">else</span> <span class="kr">if</span> <span class="p">(</span>type <span class="o">==</span> <span class="s">&#39;lrt&#39;</span><span class="p">)</span> <span class="p">{</span>
            fit <span class="o">=</span> glmFit<span class="p">(</span>d<span class="p">,</span> design<span class="p">)</span>
            test <span class="o">=</span> glmLRT<span class="p">(</span>fit<span class="p">,</span> coef<span class="o">=</span><span class="m">2</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    png<span class="p">(</span><span class="s">&#39;plotBCV.png&#39;</span><span class="p">)</span>
    plotBCV<span class="p">(</span>d<span class="p">)</span>
    dev.off<span class="p">()</span>
    png<span class="p">(</span><span class="s">&#39;plotSmear.png&#39;</span><span class="p">)</span>
    de <span class="o">=</span> decideTestsDGE<span class="p">(</span>test<span class="p">,</span> adjust.method<span class="o">=</span><span class="s">&quot;BH&quot;</span><span class="p">,</span> p.value <span class="o">=</span> <span class="m">0.05</span><span class="p">)</span>
    tags <span class="o">=</span> <span class="kp">rownames</span><span class="p">(</span>d<span class="p">)[</span><span class="kp">as.logical</span><span class="p">(</span>de<span class="p">)]</span>
    plotSmear<span class="p">(</span>test<span class="p">,</span> de.tags<span class="o">=</span>tags<span class="p">)</span>
    abline<span class="p">(</span>h<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="m">-4</span><span class="p">,</span><span class="m">4</span><span class="p">),</span> col<span class="o">=</span><span class="s">&#39;blue&#39;</span><span class="p">)</span>
    dev.off<span class="p">()</span>
    finalDGE <span class="o">=</span> topTags<span class="p">(</span>test<span class="p">,</span> n<span class="o">=</span><span class="kp">nrow</span><span class="p">(</span>exprSet<span class="p">))</span>
    finalDGE <span class="o">=</span> <span class="kp">as.data.frame</span><span class="p">(</span>finalDGE<span class="p">)</span>
    write.csv<span class="p">(</span>file<span class="o">=</span><span class="s">&#39;DGE_edgeR.txt&#39;</span><span class="p">,</span> finalDGE<span class="p">,</span> quote <span class="o">=</span> <span class="bp">F</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
		</content>

	</main>
	<footer>
		<p> Powered by xizhihui </p>
		<p> Thanks to <a href="https://www.hifreud.com/">hifreud</a> the theme is learned from his site. </p>
	</footer>

<script type="text/javascript" src="/js/index.json"></script>
<script type="text/javascript" src="/js/category.json"></script>
<script type="text/javascript" src="/js/tags.json"></script>
<script type="text/javascript" src="/js/about.json"></script>
<script type="text/javascript" src="/js/index.js"></script>
<script type="text/javascript">
	// listen to click event on navigator in header
	// document
	// 	.querySelector("div#head_right ul")
	// 	.addEventListener("click", change_page)
	var table = [['h2', 'edger', 'edgeR'], ['h3', '_1', '这是调用代码'], ['h3', '_2', '这是定义代码']]
	var html = format_article_table(table)
	var table_ele = document.querySelector("main #table")
	table_ele.innerHTML = html
	// window.onload = evt => resize_nav(table_ele)
	adaption(document, window)

</script>
</body>
</html>