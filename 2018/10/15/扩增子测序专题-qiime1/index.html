<!DOCTYPE html>
<html>
<head>
	<title>XZH's Notes</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="author" content="xizhihui" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link rel="stylesheet" type="text/css" href="/statics/reset.css">
	<link rel="stylesheet" type="text/css" href="/statics/header_footer.css"></link>
	<link rel="stylesheet" type="text/css" href="/statics/default.css">
	<link rel="stylesheet" type="text/css" href="/statics/main.css">
</head>
<body>
	<header class="Header">
		<nav>
			<h3>XZH</h3>
			<ul>
				<li><a href="/index.html#Timeline">Timeline</a></li><li><a href="/index.html#Category">Category</a></li><li><a href="/index.html#Tags">Tags</a></li><li><a href="/index.html#About">About</a></li>
			</ul>
		</nav>
	</header>
	<div class="Motto">
		<h2>XZH's Notes</h2>
		<h4>The future comes for you ~ ~ ~</h4>
	</div>

	<main>
		<nav id="table"></nav>
		<content id="content" class="content">
			<h1 id="qiime1">使用QIIME1进行扩增子分析</h1>
<h2 id="1-mapping-file">1 构建mapping file,并验证是否有误</h2>
<p>mapping file记录着样品对应的barcode、primer、treatment group等信息，以tab作为列分割符。各列名如下：</p>
<table>
<thead>
<tr>
<th>column name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>## 6 生成OTU表(biom文件)</td>
<td></td>
</tr>
</tbody>
</table>
<p>make_otu_table.py将对OTU进行汇总和注释，生成biom格式的OTU表。</p>
<h3 id="61-otu">6.1 生成OTU表</h3>
<div class="codehilite"><pre><span></span>make_otu_table.py -i otu_map.txt <span class="se">\</span>
        -t tax_assignments.txt <span class="se">\</span>
        -o otu_table.biom <span class="se">\</span>
        -m mapping_file.txt

<span class="c1"># -i &lt;input_otu_map&gt;    指定输入的OTU map，通常是pick_otus.py的结果文件</span>
<span class="c1"># -o &lt;out_biom_dir&gt;     输出结果文件</span>
<span class="c1"># -m &lt;mapping_file&gt;     指定mapping file,如果有的话</span>
<span class="c1"># -e &lt;id_file&gt;          指定排除OTU的identifiers文件</span>
</pre></div>


<h3 id="62-otu">6.2 生成OTU表同时进行过滤</h3>
<p>为了便于后续操作，一般会对OTU表进行过滤等操作.有两种方式，第一种方式是在构建的时候进行过滤，这通常是过滤嵌合体或未比对序列.另一种方式是生成otu表后，再进行过滤。其他过滤操作见3.7。</p>
<div class="codehilite"><pre><span></span><span class="c1"># identify_chimeric_seqs.py, align_seqs.py 生成不要的seqs对应的文件exclude.txt，然后在make_otu_table.py中以-e参数指定exclude.txt</span>
</pre></div>


<h2 id="7-otubiom">7 对OTU表(biom)进行操作: 过滤、拆分等</h2>
<h3 id="71">7.1 过滤</h3>
<ul>
<li>Even sampling, rarefaction (稀释)</li>
</ul>
<p>这里的抽样方式有单次抽样、多次等差抽样(稀释抽样)、多次平均抽样。single_rareefaction.py只进行一次抽样, multiple_rarefactions.py进行多次抽样(每次抽样深度不同), multiple_rarefactions_even_depth.py进行多次抽样(每次抽样深度相同)。</p>
<div class="codehilite"><pre><span></span><span class="c1"># 从otu-table中按每个样品100条序列随机抽取，并输出</span>
single_rarefaction.py -i otu_table.biom -o otu_table_even100.biom -d <span class="m">100</span>
<span class="c1"># -k &lt;bool&gt;     指定是否保留全0的OTU,default:fasle</span>
<span class="c1"># --subsample_multinomial &lt;bool&gt; 是否是放回抽样,default:fasle</span>

multiple_rarefactions.py -i otu_table.biom -m <span class="m">10</span> -x <span class="m">140</span> -s <span class="m">10</span> -n <span class="m">2</span> -o rarefied_otu_tables/
<span class="c1"># -m &lt;min_num&gt;      指定多次抽样的最低抽样数,seqs/sample, 抽样深度</span>
<span class="c1"># -x &lt;max_num&gt;      指定多次抽样的最大抽样数</span>
<span class="c1"># -s &lt;step_num&gt;     指定2次抽样的抽样次数的步长,差值</span>
<span class="c1"># -n &lt;num_reps&gt;     每一步抽样的重复次数</span>
<span class="c1"># -k，--subsample_nultinomial 同单次抽样</span>

multiple_rarefactions_even_depth.py -i otu_table.biom -o rarefied_otu_tables/ -d <span class="m">100</span> -n <span class="m">10</span>
</pre></div>


<ul>
<li>过滤OTUs/observations</li>
</ul>
<p>过滤时可以根据mapping file的某列值进行过滤，也可以根据OTU的count数来过滤(singletons, doubletons...),丰度过滤。 根据run_number的切分和过滤有点相似，但是切分是所有run切分。过滤可以只过滤某个值。</p>
<div class="codehilite"><pre><span></span><span class="c1"># 保留mapping file中某列的值等于指定值的OTUs, &quot;Sample_Type:*,!Control_Blank&quot;则表示删除</span>
filter_samples_from_otu_table.py -i split_otu_tables/otu_table_1.biom -o otu_table_run1_blank_samples.biom -m map.txt -s <span class="s2">&quot;Sample_Type:Control_Blank&quot;</span>

<span class="c1"># 排除singleton</span>
filter_otus_from_otu_table.py -i otu_table.biom -o filtered_otu_table.biom -n <span class="m">2</span>

<span class="c1"># -n &lt;min_count&gt;                    如果该OTU的total counts低于指定值,排除该OTU</span>
<span class="c1"># -x &lt;max_count&gt;                    如果该OTU的total counts高于指定值,排除该OTU</span>
<span class="c1"># -s &lt;min_samples&gt;                  如果属于该OTU的样品数低于指定值,排除该OTU</span>
<span class="c1"># -y &lt;max_samples&gt;                  如果属于该OTU的样品数超过指定值,排除该OTU</span>
<span class="c1"># -e &lt;out_ids_to_exclude_file&gt;      排除指定id的OTUs</span>
</pre></div>


<ul>
<li>过滤样本</li>
</ul>
<p>过滤样本可以基于丰度过滤，也可以基于metadata过滤，还可以基于ID过滤。过滤样本与过滤OTUs是相类似的.</p>
<div class="codehilite"><pre><span></span><span class="c1"># 保留total OTUs counts在[100,150]的样品</span>
filter_samples_from_otu_table.py -i otu_table.biom -o filtered_otu_table.biom -n <span class="m">100</span> -x <span class="m">150</span>

<span class="c1"># 保留mapping file中某列的值等于指定值的样品</span>
filter_samples_from_otu_table.py -i otu_table.biom -o filtered_otu_table.biom -m map.txt -s <span class="s1">&#39;Treatment:Control&#39;</span>

<span class="c1"># 保留mapping file中某列的值==不等于==指定值的样品</span>
filter_samples_from_otu_table.py -i otu_table.biom -o filtered_otu_table.biom -m map.txt -s <span class="s1">&#39;Treatment:*,!Control&#39;</span>

<span class="c1"># 保留在ids.txt的样品; 如果设定了--negate_sample_id_fp,则是删除在ids.txt的样品</span>
filter_samples_from_otu_table.py -i otu_table.biom -o filtered_otu_table.biom --sample_id_fp ids.txt
</pre></div>


<ul>
<li>过滤分类群: 保留属于特定分类的OTU</li>
</ul>
<p>过滤分类群时，你可以有3种逻辑的过滤方式：or, not or, not but</p>
<div class="codehilite"><pre><span></span><span class="c1"># 保留属于__Bacteroidetes 或者 p__Firmicutes</span>
filter_taxa_from_otu_table.py -i otu_table.biom -o otu_table_bac_firm_only.biom -p p__Bacteroidetes,p__Firmicutes
<span class="c1"># 保留不属于__Bacteroidetes和 p__Firmicutes</span>
filter_taxa_from_otu_table.py -i otu_table.biom -o otu_table_non_bac_firm.biom -n p__Bacteroidetes,p__Firmicutes
<span class="c1"># 保留不属于c__Clostridia但是属于p__Firmicutes</span>
filter_taxa_from_otu_table.py -i otu_table.biom -o otu_table_all_firm_but_not_clos.biom -p p__Firmicutes -n c__Clostridia

<span class="c1"># -p &lt;list, comma&gt; 保留</span>
<span class="c1"># -n &lt;list, comma&gt; 排除</span>
<span class="c1"># --metadata_field 指定用于过滤的metadata的列名</span>
</pre></div>


<h3 id="72">7.2 拆分和合并</h3>
<ul>
<li>基于mapping/metadata进行拆分</li>
</ul>
<div class="codehilite"><pre><span></span>split_otu_table.py -i otu_table.biom -m Fasting_Map.txt -f Treatment -o per_study_otu_tables
split_otu_table.py -i otu_table.biom -m Fasting_Map.txt -f Treatment,Color -o ./per_study_otu_tables/
</pre></div>


<ul>
<li>基于taxonomy(物种分类)进行拆分</li>
</ul>
<div class="codehilite"><pre><span></span><span class="c1"># 将otu_table依据Level3进行拆分</span>
split_otu_table_by_taxonomy.py -i otu_table.biom -L <span class="m">3</span> -o ./L3/
</pre></div>


<ul>
<li>合并</li>
</ul>
<p>在进行合并时，你要保证合并的两个OTUs表的OTU id和sample id是兼容的；如果两个表有重叠内容，将会计算重叠内容的值的和。</p>
<div class="codehilite"><pre><span></span>merge_otu_tables.py -i otu_table1.biom,otu_table2.biom -o merged_otu_table.biom
</pre></div>


<h3 id="73">7.3 统计汇总</h3>
<div class="codehilite"><pre><span></span><span class="c1"># 按样品进行统计汇总,取总的observations的所有counts</span>
biom summarize-table -i rich_sparse_otu_table.biom -o rich_sparse_otu_table_summary.txt
<span class="c1"># 按样品进行汇总，但只取唯一的observations的counts</span>
biom summarize-table -i rich_sparse_otu_table.biom --qualitative-o rich_sparse_otu_table_summary.txt
</pre></div>


<h3 id="74-otu">7.4 对OTU表进行排序</h3>
<div class="codehilite"><pre><span></span><span class="c1"># 按照sample id进行排序, 字母排序</span>
sort_otu_table.py -i otu_table.biom -o sorted_otu_table.biom
<span class="c1"># 按照mapping/metadata file的某个列排序</span>
sort_otu_table.py -i otu_table.biom -o dob_sorted_otu_table.biom -m Fasting_Map.txt -s Age
<span class="c1"># 按照给定顺序的sample id进行排序</span>
sort_otu_table.py -i otu_table.biom -o sorted_otu_table.biom -l sample_id_list.txt
</pre></div>


<h3 id="75-biom">7.5 biom文件的其他处理</h3>
<ul>
<li>添加metadata信息到biom文件中</li>
</ul>
<p>见<a href="http://biom-format.org/documentation/adding_metadata.html">网页tutorial</a></p>
<ul>
<li>转换biom到其他格式</li>
</ul>
<div class="codehilite"><pre><span></span><span class="c1"># json/hdf5</span>
biom convert -i table.txt -o table.from_txt_json.biom --table-type<span class="o">=</span><span class="s2">&quot;OTU table&quot;</span> --to-json
biom convert -i table.txt -o table.from_txt_hdf5.biom --table-type<span class="o">=</span><span class="s2">&quot;OTU table&quot;</span> --to-hdf5
<span class="c1"># tsv, 并添加taxonomy物种分类信息; 指定--output-metadata-id &quot;ConsensusLineage&quot;可以把添加的taxonomy列名改为ConsensusLineage</span>
biom convert -i table.biom -o table.from_biom.txt --to-tsv --header-key taxonomy
<span class="c1"># 把tsv转换回去</span>
biom convert -i otu_table.txt -o new_otu_table.biom --to-hdf5 --table-type<span class="o">=</span><span class="s2">&quot;OTU table&quot;</span> --process-obs-metadata taxonomy
</pre></div>


<h2 id="8-otu">8 物种分类分析 /群落组成分析(otu)</h2>
<h3 id="81-otu">8.1 OTU聚类分析和分类学分析</h3>
<p>此处是OTU聚类表(OTU table),OTU在每个样品中的分布信息就是OTU聚类分析；后续添加的分类注释信息就是分类学信息。</p>
<div class="codehilite"><pre><span></span><span class="c1">#1. 生成OTU聚类表, 见2.6</span>
<span class="c1">#2. 把表转换为tsv格式, 见2.7.5</span>
</pre></div>


<h3 id="82-otuotu">8.2 OTU物种注释统计、OTU物种组成图</h3>
<p>使用summeriza_taxa_through_plot.py对OTU聚类表进行统计, 以各个分类水平进行统计每个样品在该分类水平上的OTU总数,并进行可视化. 该脚本由summarize_taxa.py和plot_taxa_summary.py组成。生成的otu_table_L*.txt文件是各个Level的水平物种丰度统计表。taxa_summary_plots文件夹则是物种丰度绘制图。</p>
<div class="codehilite"><pre><span></span>summeriza_taxa_through_plots.py -o taxa_summary -i otu_table_w_tax.biom -m Fasting_Map.txt

<span class="c1"># -i &lt;input_otu_table&gt;  指定input文件, otu_table需要包含物种信息</span>
<span class="c1"># -p &lt;param_file&gt;       指定特定中间过程脚本的参数</span>
<span class="c1"># -m &lt;mapping_file&gt;     如果指定了-c,-m必须指定</span>
<span class="c1"># -c &lt;mapping_category&gt; 指定进行统计的分组信息(按组统计)</span>
<span class="c1"># -s &lt;bool&gt;             指定是否排序otu table,default: false</span>

<span class="c1"># summeriza_taxa_through_plots.py内部依序执行的命令</span>
summarize_taxa.py -i otus/otu_table.biom -o taxa_summary
plot_taxa_summary.py -i taxa_summary/otu_table_L2.txt,taxa_summary/otu_table_L3.txt,taxa_summary/otu_table_L4.txt,taxa_summary/otu_table_L5.txt,taxa_summary/otu_table_L6.txt -o taxa_summary/taxa_summary_plots/
</pre></div>


<h3 id="83-otu">8.3 OTU进化树分析(系统发育树)</h3>
<p>构建OTU系统发育树分为三个步骤，分别使用三个脚本进行.生成的树可以用meta、Figtree等软件进行查看。系统发育树的构建有多种方法,可见<a href="http://www.biotrainee.com/thread-2253-1-1.html">biotrainee</a></p>
<ol>
<li>序列比对</li>
</ol>
<p>可以选择多种方法进行序列比对,生成的文件夹命名为method_aligned的文件夹里,含有method_aligned.fasta, method_failures.fasta, method_log.txt</p>
<div class="codehilite"><pre><span></span>align_seqs.py -i otu_rep_set.fasta -o pynast_aligend/

<span class="c1"># -m &lt;align_method&gt;     指定比对序列的算法, pynast(default), infernal, clustalW, muscle, mafft</span>
<span class="c1"># -a &lt;pairwse_align&gt;    指定在PyNAST中成对比对的算法, muscle, pair_hmm, clustal, blast, uclust(default), mafft</span>
<span class="c1"># -e &lt;min_length&gt;       进行比对的序列最短长度</span>
<span class="c1"># -p &lt;min_percent_id&gt;   blast中最低的一致性占比(default:0.75)</span>
<span class="c1"># -d &lt;blast_db&gt;         当-m pynast时, 进行blast的数据库</span>
<span class="c1"># -t &lt;template_align&gt;   指定预比对的文件;可在http://greengenes.lbl.gov/下载获得</span>
<span class="c1"># --muscle_max_memory</span>

align_seqs.py -i <span class="nv">$PWD</span>/unaligned.fna -t core_set_aligned.fasta.imputed -o <span class="nv">$PWD</span>/pynast_aligned/ -e <span class="m">500</span> -p <span class="m">95</span>.0
</pre></div>


<ol>
<li>过滤比对结果中的高变异区</li>
</ol>
<div class="codehilite"><pre><span></span>filter_alignment.py -i pynast_aligned/otu_rep_set_aligned.fasta -o pynast_aligned/ --remove_outliers -g <span class="m">0</span>.95

<span class="c1"># -m &lt;lane_mask_file&gt;   指定在构建树时保留位点的lanemask文件</span>
<span class="c1"># -s &lt;suppress_lane_mask_filter&gt;</span>
<span class="c1"># -g &lt;allow_grap_frac&gt;  指定某个位点所允许的最少gap数</span>
<span class="c1"># -t &lt;threshold&gt;        指定认定为outlier的偏离标准偏差倍数, default=3</span>
<span class="c1"># -r &lt;remove_outliers&gt;  指定过滤outlier</span>
</pre></div>


<ol>
<li>生成树</li>
</ol>
<div class="codehilite"><pre><span></span>make_phylogeny.py -i pynast_aligned/otu_rep_set_aligned_pfilter.fasta -o rep_set.tre

<span class="c1"># -t &lt;tree_method&gt;      指定进行建树的方法, clustalw, raxml_v730, muscle, fasttree(default), clearcut</span>
<span class="c1"># -l &lt;log_fp&gt;           log的存储位置, 不指定的话不会创建log</span>
<span class="c1"># -r &lt;root_method&gt;      指定构建树的根(root)的方法, midpoint, tree_method_default(default)</span>
</pre></div>


<h3 id="84-otu-heatmap">8.4 OTU Heatmap绘制（物种分类热图)</h3>
<p>使用make_otu_heatmap.py就对OTU表绘制热图，热图的每一行对应着一个OTU，每一列对应着一个样本。颜色代表了对应样本(列)的对应OTU(行)的丰度(counts).默认情况下，OTUs(行)将会使用UPGMA层次聚类，样品(列)将会按照在OTU表中出现的顺序进行排列。用户可以按照聚类树对行/列进行排序，也可以按照mapping file排序样品，对于后者，样品将会进行分组并聚类。</p>
<div class="codehilite"><pre><span></span><span class="c1"># default</span>
make_otu_heatmap.py -i otu_table.biom -o heatmap.pdf

<span class="c1"># -t &lt;otu_tree&gt;     指定用于OTUs排序的OTU tree</span>
<span class="c1"># -m &lt;mapping_file&gt; 指定用于样品排序的meta/mapping file</span>
<span class="c1"># -c &lt;category&gt;     指定用于样品排序的mapping file 列(分组)。</span>
<span class="c1"># -s &lt;sample_tree&gt;  指定用于样品排序的sample_tree,可来源于upgma_cluster.py的输出</span>
<span class="c1"># -g &lt;image_type&gt;   输出热图的格式, png, svg, pdf(default)</span>
<span class="c1"># --no_log_transform 不进行log转换, 0值被设为最小值的1/2</span>
<span class="c1"># --suppress_row/column_clustering 不进行upgma聚类,-t/-m设定了,不聚类的设定被忽略</span>
<span class="c1"># --absolute_abundance 不进行百分比化</span>
<span class="c1"># --color_scheme    指定颜色主题</span>
<span class="c1"># --width,--height,--dpi 指定热图图片相关格式</span>
<span class="c1"># --obs_md_category     observation metadata category to plot</span>
<span class="c1"># --obs_md_level    The level of observation metadata to plot for hierarchical metadata</span>
</pre></div>


<h3 id="85-otu-network">8.5 OTU network分析</h3>
<p>make_otu_network.py可以利用OTU和metadata/mapping file生成用于cytoscape可视化的网络文件，并对网络进行统计。进行网络分析是因为他可以展示和分析样品之间OTUs的分布，这对于展示大数据中样本的相似性和差别十分便捷。可视化结果展示的是根据样品之间共有OTUs数目的聚类结果，网络的加权值是每个OTU所含有的序列数。然后根据网络节点间的关联来统计其聚类模式，这其中用到G-test(我不懂啊)。</p>
<p>基于network分析的样品比较与基于tree的PCoA分析相得益彰。在多数研究中，这两个方法的结果总是相一致的，但是反映这数据的不同方面。network分析提供了系统发育的可视化呈现，PCoA-unifrac聚类提供了发育的聚类水平，这有可能在network观察到。从技术上讲，OTUs和样品是network中的两种节点, OTU-node通过edges同sample-node连接，这些edges就是samples在OTUs中的序列。</p>
<div class="codehilite"><pre><span></span>make_otu_network.py -i otu_table.biom -m Fasting_Map.txt -o otu_network
<span class="c1"># -b &lt;color_by&gt;         指定依据mapping_file的特定列进行着色,可逗号分隔指定多个</span>
<span class="c1"># -k &lt;bg_color&gt;         指定网络的背景色</span>
</pre></div>


<h2 id="9-alpha-diversity-analysis">9 α多样性分析 (alpha diversity analysis)</h2>
<p>α多样性的分析主要是通过计算<a href="http://scikit-bio.org/docs/latest/generated/skbio.diversity.alpha.html">各项α多样性指数</a>来表征α多样性的, 比如Shannon指数、ACE指数、Chao1指数等。</p>
<h3 id="91">9.1 计算指数和对应的指数稀释曲线</h3>
<p>alpha diversity index and rarefaction curve. 在alpha_rarefaction.py中，可以生成稀释OTU table，基于稀释表计算α多样性矩阵，然后画出稀释曲线图。可计算的α多样性指数有：ace, berger_parker_d, brillouin_d, chao1, chao1_ci, dominance, doubles, enspie, equitability, esty_ci, fisher_alpha, gini_index, goods_coverage, heip_e, kempton_taylor_q, margalef, mcintosh_d, mcintosh_e, menhinick, michaelis_menten_fit, observed_otus, observed_species, osd, simpson_reciprocal, robbins, shannon, simpson, simpson_e, singles, strong, PD_whole_tree</p>
<div class="codehilite"><pre><span></span><span class="c1"># 指定需要计算的α多样性指数</span>
<span class="nb">echo</span> <span class="s1">&#39;alpha_diversity:metrics simpson,shannon,PD_whole_tree,chao1,observed_species&#39;</span> &gt; alpha_params.txt
alpha_rarefaction.py -i otu_table.biom -o arare_max100/ -t rep_set.tre -m Fasting_Map.txt -e <span class="m">100</span> -p alpha_params.txt
<span class="c1"># -p &lt;parameter_fp&gt;         指定过程脚本对应的参数</span>
<span class="c1"># -n &lt;num_steps&gt;            指定进行抽样时的步数,不是步长, 是生成稀释OTU表的大小</span>
<span class="c1"># -w                        只打印过程脚本，不运行</span>
<span class="c1"># -a                        指定进行多线程</span>
<span class="c1"># -t &lt;tree_file&gt;            指定计算系统发育指数的tree</span>
<span class="c1"># --min_rare_depth &lt;num&gt;    指定抽样时的最小深度</span>
<span class="c1"># -e,--max_rare_depth &lt;num&gt; 指定抽样时的最大深度</span>
<span class="c1"># -O &lt;jobs_to_start&gt;        指定跳转到第几步开始执行,重新执行时十分有用</span>
<span class="c1"># -f                        指定强制覆写文件</span>
<span class="c1"># --retain_intermediate_files   指定保留中间过程文件</span>

multiple_rarefactions.py -i ../04_pick_open_ref_otus/otu_table_mc2.biom <span class="se">\</span>
        -m <span class="m">10</span> -x <span class="m">100</span> <span class="se">\</span>
        -s <span class="m">9</span> -o ./alpha/rarefaction/
alpha_diversity.py -i ./alpha/rarefaction/ 
        -o ./alpha/alpha_div/ <span class="se">\</span>
        --metrics simpson,shannon,PD_whole_tree,chao1,observed-species <span class="se">\</span>
        -t ../04_pick_open_ref_otus/rep_set.tre
collate_alpha.py -i ./alpha/alpha_div/ <span class="se">\</span>
        -o ./alpha/alpha_div_collated/
rm -r ./alpha/rarefaction/ ./alpha/alpha_div/
make_rarefaction_plots.py -i ./alpha/alpha_div_collated/ <span class="se">\</span>
        -m ../map.tsv <span class="se">\</span>
        -o ./alpha/alpha_rarefaction_plots/
</pre></div>


<h3 id="92-rank-abundance">9.2 Rank-abundance曲线</h3>
<div class="codehilite"><pre><span></span><span class="c1"># 比较多个样品的排序-丰度曲线图；如果想比较一个OTU表里面的所有样品, -s &#39;*&#39; 即可</span>
plot_rank_abundance_graph.py -i otu_table.biom -s <span class="s1">&#39;PC.354,PC.481,PC.364&#39;</span> -x -v -o rank_abundance.pdf
<span class="c1"># -s &lt;sample_name&gt;      画图的样品名</span>
<span class="c1"># -a,--absolute_counts  指定图中使用的数据是绝对丰度,</span>
<span class="c1"># -n,--no_legend        指定图中不画图例</span>
<span class="c1"># -x,--x_linear_scale   指定x轴要进行线性缩放</span>
<span class="c1"># -y,--y_linear_scale   指定y轴要进行线性缩放</span>
<span class="c1"># -f &lt;file_type&gt;        指定输出图的类型, pdf(default), svg, png, eps</span>
<span class="c1"># -v                    输出过程信息</span>
</pre></div>


<h3 id="93">9.3 α多样性指数差异分析</h3>
<p>基于样品的多样性指数，可以检验组间样品的alpha diversity是否存在显著差异，检验方法可以是Wilcoxon秩和检验(2组样品)或者Kruskal-Willis秩和检验(多于两组).</p>
<div class="codehilite"><pre><span></span><span class="c1"># 汇总计算的所有alpha diversity index, 如果是执行了3.9.1,则不必执行本命令;</span>
collate_alpha.py -i alpha_div/ -o alpha_div_collated/

<span class="c1"># 比较alpha diversity index，按SampleType作为分组，得到每个diversity index下的成对组间统计</span>
ls alpha/alpha_div_collated/*.txt <span class="p">|</span> <span class="k">while</span> <span class="nb">read</span> div<span class="p">;</span>
<span class="k">do</span>
<span class="nv">name</span><span class="o">=</span><span class="sb">`</span>basename <span class="nv">$div</span> .txt<span class="sb">`</span>
compare_alpha_diversity.py -i <span class="nv">$div</span> -m ../map.tsv -c SampleType -d <span class="m">100</span> -o compare_alpha_div/<span class="nv">$name</span>
<span class="k">done</span>
<span class="c1"># 如果想把各个diversity index合在一张图,需要用额外的R代码</span>
</pre></div>


<h3 id="94-species-accumulation-curves">9.4 物种累积曲线  (species accumulation curves)</h3>
<div class="codehilite"><pre><span></span># 可以使用R的vegan包
</pre></div>


<h2 id="10-beta-diversity-analysis">10 β 多样性分析  (beta diversity analysis)</h2>
<p><a href="http://www.omicshare.com/forum/thread-3251-1-1.html">微生物群落差异分析方法大揭秘</a></p>
<h3 id="100-pcoa">10.0 一步法进行PCoA分析</h3>
<p>beta_diversity_through_plot.py可以进行β多样性分析、主坐标轴分析，并画出3D PCoA图. 首先该脚本会随机对输入的otu_table.biom进行抽样，以达到抽平每个样品的序列数目的目的。然后计算各个表征β多样性的距离矩阵。最后基于这些距离矩阵进行主坐标轴分析，并对结果进行可视化。</p>
<div class="codehilite"><pre><span></span>beta_diversity_through_plots.py -i otu_table.biom -m map.tsv -o beta_diversity -e <span class="m">100</span>
<span class="c1"># -t &lt;tree_fp&gt;      指定树的文件</span>
<span class="c1"># -p &lt;param_fp&gt;     指定中间命令的参数文件</span>
<span class="c1"># -f,-w             强制覆写和只打印命令不运行</span>
<span class="c1"># -a                指定多线程运行</span>
<span class="c1"># -e &lt;seqs_per_sample&gt; 进行样品抽平的覆盖深度</span>
<span class="c1"># --supress_emperor_plots</span>
<span class="c1"># -O,--jobs_to_start 跳转到第几步开始运行。</span>
</pre></div>


<h3 id="101">10.1 计算β多样性距离矩阵</h3>
<p>beta_diversity.py支持计算多种距离矩阵, 使用-s参数查看支持的矩阵.由于unifrac，还需要提供发育树作为输入。一般来讲，由于unifrac有用到系统发育信息，所以一般推荐使用unifrac。定量的距离矩阵(weighted)更适合用于揭示由于群落物种丰度引起的群落差异,而定性的距离矩阵更适用于因环境不同所导致的群落差异。</p>
<p><strong>2.10.2-2.10.5等分析均基于本步骤生成的距离矩阵进行后续的分析。</strong></p>
<div class="codehilite"><pre><span></span><span class="c1"># 查看支持的矩阵类型,然后选择想要计算的距离矩阵</span>
beta_diversity.py -s
<span class="nv">metrics</span><span class="o">=</span>unweighted_unifrac,weighted_unifrac,bray_curtis,binary_jaccard
beta_diversity.py -i 04_pick_open_ref_otus/otu_table_mc2.biom <span class="se">\</span>
        -o 05_beta_diversity <span class="se">\</span>
        --metrics <span class="nv">$metrics</span> <span class="se">\</span>
        -t 04_pick_open_ref_otus/rep_set.tre

mv 05_beta_diversity/weighted_unifrac_otu_table_mc2.txt 05_beta_diversity/weighted_unifrac_distance_matrix.txt

<span class="c1"># -i &lt;otu_table&gt;    指定输入otu_table, 可以以文件夹的形式指定多个</span>
<span class="c1"># -r &lt;rows&gt;         指定只计算指定行的距离矩阵,应该传入样品名,例如&#39;S1,S3&#39;之类的</span>
<span class="c1"># -m &lt;metrics&gt;      指定要计算的beta diversity matrix类型, 可以用逗号分隔指定多个,默认: unweighted_unifrac,weighted_unifrac</span>
<span class="c1"># -s &lt;show_metrics&gt; 显示支持的距离矩阵类型</span>
<span class="c1"># -t &lt;tree_file&gt;    指定输入的系统发育树</span>
<span class="c1"># -f &lt;full_tree&gt;    指定使用全部的系统树;OTU table与系统树不对应的话,使用全部整个系统树会导致很多额外的结果.</span>
</pre></div>


<h3 id="102-pcoa">10.2 PCoA分析</h3>
<div class="codehilite"><pre><span></span><span class="c1"># -i,-o还可以是文件夹用以进行批量计算</span>
principal_coordinates.py -i 05_beta_diversity/weighted_unifrac_dm.txt <span class="se">\</span>
        -o 05_beta_diversity/weighted_unifrac_pc.txt

<span class="c1"># 画2d图</span>
make_2d_plots.py -i weighted_unifrac_pc.txt -m map.tsv -o 2d_plots
<span class="c1"># -b &lt;color_by&gt;         以逗号分隔的metadata分类/组列名,用以指定着色分组。可以使用&#39;col1&amp;&amp;col2&#39;指定一致着色</span>
<span class="c1"># -k &lt;bg_color&gt;</span>
<span class="c1"># --ellipsoid_opacity   指定透明度,只在jackknifed beta diversity中有用</span>
<span class="c1"># --ellipsoid_method    指定绘制的数据类型, IQR (default) 和 sdev, 只在jackknifed beta diversity中有用</span>
<span class="c1"># --master_pcoa         </span>
<span class="c1"># --scree               绘制碎石图</span>

<span class="c1"># 画3d图</span>
make_emperor.py -i 05_beta_diversity/weighted_unifrac_pc.txt <span class="se">\</span>
        -o 05_beta_diversity/weighted_unifrac_emperor_pcoa_plot/ <span class="se">\</span>
        -m map.tsv

make_emperor.py -i weighted_unifrac_pc.txt -m map.tsv <span class="se">\</span>
        -b <span class="s1">&#39;Treatment&amp;&amp;DOB,Treatment&#39;</span> <span class="se">\ </span><span class="c1"># 依据metadata进行着色</span>
        -a DOB <span class="se">\ </span><span class="c1"># 指定一个轴为DOB</span>
        -x <span class="s1">&#39;DOB:20060000&#39;</span> <span class="se">\ </span><span class="c1"># 当自定义轴DOB出现缺失值或值错误时,指定为20060000</span>
        -o emperor_colored
<span class="c1"># 见https://biocore.github.io/emperor/build/html/scripts/make_emperor.html</span>
</pre></div>


<h3 id="103-pca">10.3 PCA分析</h3>
<div class="codehilite"><pre><span></span>PCA分析基于OTU表，运用方差分解，将样本间的差异反映在二维坐标图上，坐标轴是两个主成分。样本组成越相似在图中则越聚集。
待续.
</pre></div>


<h3 id="104-nmds">10.4 NMDS分析</h3>
<p>与 PCoA 一样， 非度量多维尺度分析（ NMDS, nonmetric multidimensional scaling） 可以基于任何类型的距离/非相似性矩阵对对象（样本） 进行排序，其区别在于 NMDS 不再是特征根排序技术，也不再以排序轴承载更多的方差为目的，因此 NMDS 排序图可以任意旋转、中心化和倒置。 NMDS 分析在多维空间内构建对象的初始结构， 并用迭代程序不断地调整对象位置， 目标是尽可能的最小化应力函数（ stress function， 取值 0~1），应力函数是排序空间内对象结果与原始距离矩阵之间相异程度的度量。如果预先设定的排序轴数量比较少（如二维、三维），则在相同轴数的情况下， NMDS往往能够获得比 PCoA 更少失真的对象之间的关系。</p>
<p>R包vegan可以进行NMDS分析和作图。</p>
<div class="codehilite"><pre><span></span>nmds.py -i unweighted_unifrac_dm.txt -d 3 -o unweighted_unifrac_nmds.txt
# -i,-o             如果-i指定的是文件夹，那么就进行批量分析
# -d &lt;dimensions&gt;   指定NMDS分析的排序轴数量
</pre></div>


<h3 id="105-adonisanosim">10.5 ADONIS、ANOSIM分析</h3>
<p>通过compare_categories.py，我们可以比较不同组样品的聚类结果是否有显著性差异，该脚本提供多种方法，根据方法不同输出结果不同，但大多数是tsv文件。</p>
<p><strong>adonis</strong>, 又叫permanova, 是一种非参数检验方法。能够给出不同分组因素对样品差异的解释度（R值）与分组显著性（P值），它首先计算数据的相关性重心，然后计算这些重心点的平方偏差(R^2);最后基于原始数据的排列平方和进行F-test; 它以距离矩阵和mapping file作为输入，比如Unifrac聚类矩阵，通过指定分组列来进行比较。</p>
<p><strong>anosim</strong>,相似性分析，也是检验多组样本之间是否具有显著性差异，与adonis相似。但是它只对类别性变量有用，如果数据是连续型变量，推荐使用Mantel。它的计算公式为R=(rb-rw)/(N(N-1)/4)。其中rb指组间的所有距离的平均排名，rw指组内所有距离的平均排名。</p>
<p>adnois和anosim分析都只能衡量组与组之间整体是否有显著差异, 无法找到是哪个具体的OTU导致的该差异。</p>
<div class="codehilite"><pre><span></span><span class="c1"># 看HOST_SUBJECT_ID分组的组间结果是否会有差异</span>
compare_categories.py --method adonis -i unweighted_unifrac_dm.txt -m map.txt -c HOST_SUBJECT_ID -o adonis_out -n <span class="m">999</span>
<span class="c1"># --method &lt;method&gt;         指定统计方法, adonis,anosim</span>
<span class="c1"># -i  &lt;distance_matrix&gt;     指定输入的距离矩阵</span>
<span class="c1"># -m &lt;mapping_file&gt;         指定输入的mapping file</span>
<span class="c1"># -c &lt;group/category&gt;       指定进行差异分析的分组方式</span>
<span class="c1"># -n &lt;permutations_num&gt;     指定进行计算p-value的排名数(前多少名)</span>
</pre></div>


<h3 id="106">10.6 样本聚类树图</h3>
<p>样本聚类树可以从整体上描述和比较样本/分组见的相似性和差异性. 采用的聚类方法是UPGMA (unweighted pair group method with arithmetic mean, http://www.nmsr.org/upgma.htm), 这里以使用unweighted_unifrac聚类矩阵为例.</p>
<div class="codehilite"><pre><span></span># unweighted_unifrac_dm.txt来源于3.10.1
upgma_cluster.py -i unweighted_unifrac_dm.txt -o unweighted_unifrac_cluster.tre

# 如果要探究生成的聚类树的健壮性的话，就进行jackknifed_beta_diversity分析
# otu_table.biom是unweighted_unifrac_dm.txt的计算来源table
jackknifed_beta_diversity.py -i otu_table.biom -o bdiv_jk100 -e 100 -m map.tsv -t rep_set.tre
</pre></div>


<h3 id="107-lefse">10.7 Lefse分析</h3>
<p>线性判别分析（ LDA）效应量方法
http://www.omicshare.com/forum/forum.php?mod=viewthread&amp;tid=563&amp;extra=page%3D1%26filter%3Dtypeid%26typeid%3D31</p>
<div class="codehilite"><pre><span></span>conda install lefse -y
conda install <span class="nv">rpy2</span><span class="o">=</span><span class="m">2</span>.8.6 -y
<span class="c1"># 如果出现rpy2与matplotlib有conflict,删除matplotlib,先安装rpy2,后安装matplotlib</span>
conda remove matplotlib --force
<span class="c1"># 如果有某个包总是断网下载不下来（得到该包的版本）,先安装这个包，再去安装rpy2</span>
<span class="c1"># https://anaconda.org/，下载对应包的对应版本</span>
conda install --use-local package_name

<span class="c1"># 1. 先转化biom为TSV文件, 注意--header-key是taxonomy,非Taxonomy</span>
biom convert -i illumina/04_pick_open_ref_otus/otu_table_mc2_w_tax.biom -o otu_consensus.txt --to-tsv --header-key taxonomy --output-metadata-id <span class="s2">&quot;Consensus Lineage&quot;</span>

<span class="c1"># 2. 转化为lefse的初始格式,设定分组、亚组和个体信息; 这里十分重要</span>
qiime2lefse.py --in otu.txt <span class="se">\</span>
               --md illumina/map.tsv <span class="se">\</span>
               --out otu_lefse.txt <span class="se">\</span>
               -c SampleType <span class="se">\</span>
               -u Subject

<span class="c1"># 3. 转换为lefse接受的格式</span>
lefse-format_input.py otu_lefse.txt otu_lefse.in -c <span class="m">1</span> -s -1 -u <span class="m">2</span>

<span class="c1"># 4. 走正常的分析流程</span>
run_lefse.py otu_lefse.in otu_lefse.res
lefse-plot_res.py otu_lefse.res otu_lefse.png
lefse-plot cladogram.py otu_lefse_res otu_lefse.cladogram.png --format png
mkdir biomarkers_raw_image
lefse-plot_features.py otu_lefse.in otu_lefse.res biomarkers_raw_images/
</pre></div>
		</content>

	</main>
	<footer>
		<p> Powered by xizhihui </p>
		<p> Thanks to <a href="https://www.hifreud.com/">hifreud</a> the theme is learned from his site. </p>
	</footer>

<script type="text/javascript" src="/js/index.json"></script>
<script type="text/javascript" src="/js/category.json"></script>
<script type="text/javascript" src="/js/tags.json"></script>
<script type="text/javascript" src="/js/about.json"></script>
<script type="text/javascript" src="/js/index.js"></script>
<script type="text/javascript">
	// listen to click event on navigator in header
	// document
	// 	.querySelector("div#head_right ul")
	// 	.addEventListener("click", change_page)
	var table = [['h2', '1-mapping-file', '1 构建mapping file,并验证是否有误'], ['h3', '61-otu', '6.1 生成OTU表'], ['h3', '62-otu', '6.2 生成OTU表同时进行过滤'], ['h2', '7-otubiom', '7 对OTU表(biom)进行操作: 过滤、拆分等'], ['h3', '71', '7.1 过滤'], ['h3', '72', '7.2 拆分和合并'], ['h3', '73', '7.3 统计汇总'], ['h3', '74-otu', '7.4 对OTU表进行排序'], ['h3', '75-biom', '7.5 biom文件的其他处理'], ['h2', '8-otu', '8 物种分类分析 /群落组成分析(otu)'], ['h3', '81-otu', '8.1 OTU聚类分析和分类学分析'], ['h3', '82-otuotu', '8.2 OTU物种注释统计、OTU物种组成图'], ['h3', '83-otu', '8.3 OTU进化树分析(系统发育树)'], ['h3', '84-otu-heatmap', '8.4 OTU Heatmap绘制（物种分类热图)'], ['h3', '85-otu-network', '8.5 OTU network分析'], ['h2', '9-alpha-diversity-analysis', '9 α多样性分析 (alpha diversity analysis)'], ['h3', '91', '9.1 计算指数和对应的指数稀释曲线'], ['h3', '92-rank-abundance', '9.2 Rank-abundance曲线'], ['h3', '93', '9.3 α多样性指数差异分析'], ['h3', '94-species-accumulation-curves', '9.4 物种累积曲线  (species accumulation curves)'], ['h2', '10-beta-diversity-analysis', '10 β 多样性分析  (beta diversity analysis)'], ['h3', '100-pcoa', '10.0 一步法进行PCoA分析'], ['h3', '101', '10.1 计算β多样性距离矩阵'], ['h3', '102-pcoa', '10.2 PCoA分析'], ['h3', '103-pca', '10.3 PCA分析'], ['h3', '104-nmds', '10.4 NMDS分析'], ['h3', '105-adonisanosim', '10.5 ADONIS、ANOSIM分析'], ['h3', '106', '10.6 样本聚类树图'], ['h3', '107-lefse', '10.7 Lefse分析']]
	var html = format_article_table(table)
	var table_ele = document.querySelector("main #table")
	table_ele.innerHTML = html
	// window.onload = evt => resize_nav(table_ele)
	adaption(document, window)

</script>
</body>
</html>